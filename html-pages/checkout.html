<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Checkout – The Peptide Hub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--bg:#0b0b0c;--panel:#141416;--muted:#a7a7ad;--text:#fff;--ok:#19c37d;--err:#ff6166;--brand:#7c3aed}
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    a{color:var(--ok);text-decoration:none}
    .container{max-width:960px;margin:32px auto;padding:16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:24px}
    .card{background:var(--panel);border:1px solid #242427;border-radius:16px;padding:20px}
    h1{margin:0 0 8px 0;font-size:28px}
    h2{margin:0 0 12px 0;font-size:20px}
    label{display:block;font-size:14px;color:var(--muted);margin:10px 0 6px}
    input,select,button,textarea{
      width:100%;padding:12px 14px;border-radius:12px;border:1px solid #2a2a2e;background:#0f0f11;color:#fff
    }
    input:focus,select:focus,textarea:focus{outline:2px solid #2f2f35;border-color:#3a3a40}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .muted{color:var(--muted);font-size:13px}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#1b1b1e;border:1px solid #2a2a2e;font-size:12px;color:var(--muted)}
    .pm-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .pm-option{cursor:pointer;display:flex;align-items:center;justify-content:center;padding:12px;border-radius:12px;border:1px solid #2a2a2e;background:#111113}
    .pm-option input{display:none}
    .pm-option.active{border-color:var(--brand);box-shadow:0 0 0 2px rgba(124,58,237,.25) inset}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #2a2a2e}
    tfoot td{border-top:1px solid #2a2a2e;border-bottom:none}
    .right{text-align:right}
    .actions{display:flex;gap:12px;margin-top:16px}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:14px 16px;border-radius:12px;border:1px solid #2a2a2e;background:#19191c;color:#fff;cursor:pointer;width:100%}
    .btn.primary{background:linear-gradient(135deg,var(--brand),#4c1d95)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .alert{margin-top:12px;padding:12px;border-radius:12px;border:1px solid #2a2a2e;background:#121214}
    .alert.ok{border-color:#1f5f49;background:#0e1f18}
    .alert.err{border-color:#5f1f21;background:#1f0e0f}
    .small{font-size:12px}
    .disclaimer{font-size:12px;color:#b3b3ba;background:#121214;border:1px dashed #2a2a2e;border-radius:12px;padding:10px;margin-top:10px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <h1>Checkout</h1>
    <div class="grid">
      <!-- Left: Shipping & Payment -->
      <div class="card">
        <h2>Contact & Shipping</h2>
        <label>Email</label>
        <input id="email" type="email" placeholder="you@example.com" autocomplete="email" required />

        <label>Full name (for research)</label>
        <input id="name" placeholder="e.g. Jane Researcher" autocomplete="name" />

        <label>Address line 1</label>
        <input id="addr1" autocomplete="address-line1" placeholder="123 Main St" />

        <label>Address line 2</label>
        <input id="addr2" autocomplete="address-line2" placeholder="Apt, suite, etc. (optional)" />

        <div class="row">
          <div>
            <label>City</label>
            <input id="city" autocomplete="address-level2" />
          </div>
          <div>
            <label>State / Province</label>
            <input id="state" autocomplete="address-level1" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Postal code</label>
            <input id="zip" inputmode="numeric" autocomplete="postal-code" />
          </div>
          <div>
            <label>Country</label>
            <select id="country">
              <option value="US" selected>United States</option>
              <option value="CA">Canada</option>
              <option value="GB">United Kingdom</option>
              <option value="AU">Australia</option>
            </select>
          </div>
        </div>

        <div style="height:12px"></div>
        <h2>Payment</h2>
        <div class="pm-grid" id="pmGrid">
          <label class="pm-option"><input type="radio" name="pm" value="cashapp" />Cash App</label>
          <label class="pm-option"><input type="radio" name="pm" value="venmo" />Venmo</label>
          <label class="pm-option"><input type="radio" name="pm" value="zelle" />Zelle</label>
          <label class="pm-option"><input type="radio" name="pm" value="bitcoin" />Bitcoin</label>
        </div>

        <div class="disclaimer">
          <strong>Research Use Only.</strong> By placing an order you confirm you are purchasing for research purposes. Not for human consumption.
        </div>

        <div class="actions">
          <button id="btnTest" class="btn">Fill test data</button>
          <button id="btnSubmit" class="btn primary">Submit Order</button>
        </div>

        <div id="msg" class="alert" style="display:none"></div>
      </div>

      <!-- Right: Cart summary -->
      <div class="card">
        <h2>Order summary</h2>
        <div class="muted small" id="cartHint">Loading cart…</div>
        <table id="cartTable" style="display:none">
          <thead>
            <tr><th>Item</th><th class="right">Qty</th><th class="right">Price</th></tr>
          </thead>
          <tbody id="cartBody"></tbody>
          <tfoot>
            <tr><td colspan="2" class="right">Subtotal</td><td class="right" id="subtotalCell">$0.00</td></tr>
          </tfoot>
        </table>
        <div style="margin-top:12px" class="muted small">
          Need help? Email <a href="mailto:support@thepeptidehub.net">support@thepeptidehub.net</a>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ---------- Small utils ----------
    const $ = (id) => document.getElementById(id);
    const fmtUSD = (cents) => '$' + (cents/100).toFixed(2);
    const cents = (n) => Math.round(Number(n) * 100);

    function showMsg(kind, text) {
      const box = $('msg');
      box.className = 'alert ' + (kind === 'ok' ? 'ok' : 'err');
      box.style.display = 'block';
      box.textContent = text;
    }
    function clearMsg(){ const box=$('msg'); box.style.display='none'; box.textContent='' }

    // ---------- Payment picker UI ----------
    const pmGrid = $('pmGrid');
    pmGrid.addEventListener('click', (e)=>{
      const label = e.target.closest('.pm-option');
      if (!label) return;
      pmGrid.querySelectorAll('.pm-option').forEach(x=>x.classList.remove('active'));
      label.classList.add('active');
      const input = label.querySelector('input[type=radio]');
      input.checked = true;
    });

    // ---------- Cart adapter ----------
    /**
     * We’ll try multiple places so it works with your existing site without changes.
     * Accepted item shape: { sku, name, qty, price } where price can be cents or "$199.00" or 199
     */
    function parseItem(raw) {
      const sku = raw.sku || raw.id || raw.handle || 'SKU';
      const name = raw.name || raw.title || sku;
      const qty = Number(raw.qty ?? raw.quantity ?? 1);
      let price = raw.price ?? raw.price_cents ?? raw.unit_price;
      if (typeof price === 'string') {
        const m = price.replace(/[^0-9.]/g,'');
        price = Number(m.includes('.') ? (Number(m)*100).toFixed(0) : m);
      } else if (typeof price === 'number' && price < 1000) {
        // looks like dollars
        price = Math.round(price * 100);
      }
      return { sku, name, qty, price: Number(price) };
    }

    function loadCart() {
      // 1) URL ?sku=&name=&price=&qty=
      const qp = new URLSearchParams(location.search);
      if (qp.get('sku')) {
        const item = parseItem({
          sku: qp.get('sku'),
          name: qp.get('name') || qp.get('sku'),
          qty: Number(qp.get('qty') || 1),
          price: qp.get('price') || '0'
        });
        return [item];
      }

      // 2) localStorage common keys
      const keys = ['peptidehub_cart', 'cart', 'th_cart', 'cartItems'];
      for (const k of keys) {
        try {
          const raw = JSON.parse(localStorage.getItem(k) || 'null');
          if (!raw) continue;
          // arrays or maps
          if (Array.isArray(raw)) return raw.map(parseItem);
          if (raw.items && Array.isArray(raw.items)) return raw.items.map(parseItem);
          if (typeof raw === 'object') return Object.values(raw).map(parseItem);
        } catch {}
      }

      // 3) fallback example (Retatrutide $199)
      return [{ sku:'RETATRUTIDE', name:'Retatrutide', qty:1, price:19900 }];
    }

    function renderCart(items){
      const tbody = $('cartBody');
      tbody.innerHTML = '';
      let subtotal = 0;
      items.forEach(it=>{
        subtotal += (it.price * it.qty);
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${it.name}</td><td class="right">${it.qty}</td><td class="right">${fmtUSD(it.price)}</td>`;
        tbody.appendChild(tr);
      });
      $('subtotalCell').textContent = fmtUSD(subtotal);
      $('cartHint').style.display = 'none';
      $('cartTable').style.display = '';
      return subtotal;
    }

    const CART = loadCart();
    let SUBTOTAL = renderCart(CART);

    // ---------- Submit ----------
    $('btnTest').addEventListener('click', ()=>{
      $('email').value = 'test@example.com';
      $('name').value = 'Test Research';
      $('addr1').value = '123 Main St';
      $('addr2').value = '';
      $('city').value = 'Dodge City';
      $('state').value = 'KS';
      $('zip').value = '67801';
      $('country').value = 'US';
      // Select Cash App
      const first = pmGrid.querySelector('label.pm-option');
      pmGrid.querySelectorAll('.pm-option').forEach(x=>x.classList.remove('active'));
      first.classList.add('active'); first.querySelector('input').checked = true;
    });

    $('btnSubmit').addEventListener('click', async ()=>{
      clearMsg();
      const btn = $('btnSubmit');
      btn.disabled = true; btn.textContent = 'Submitting…';

      // Basic validation
      const email = $('email').value.trim();
      if (!email || !/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)) { showMsg('err','Please enter a valid email.'); btn.disabled=false; btn.textContent='Submit Order'; return; }
      const pmInput = pmGrid.querySelector('input[name=pm]:checked');
      if (!pmInput) { showMsg('err','Select a payment method.'); btn.disabled=false; btn.textContent='Submit Order'; return; }
      if (!CART.length || SUBTOTAL <= 0) { showMsg('err','Your cart is empty.'); btn.disabled=false; btn.textContent='Submit Order'; return; }

      // Build payload (matches the Netlify function)
      const payload = {
        email,
        name: $('name').value.trim() || null,
        address: {
          line1: $('addr1').value.trim() || null,
          line2: $('addr2').value.trim() || null,
          city: $('city').value.trim() || null,
          state: $('state').value.trim() || null,
          postal_code: $('zip').value.trim() || null,
          country: $('country').value || 'US'
        },
        items: CART,
        subtotal_cents: SUBTOTAL,
        payment_method: pmInput.value
      };

      // Call Netlify function
      try {
        const res = await fetch('/.netlify/functions/order-create', {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify(payload)
        });

        // Helpful status diagnostics
        if (res.status === 404) throw new Error('Order service not found (404). Netlify Functions might not be deploying.');
        if (res.status === 405) throw new Error('Order service is live but needs POST (405). This means Functions are deployed.');

        const data = await res.json().catch(()=>({error:'Invalid JSON response'}));
        if (!res.ok || !data.ok) {
          throw new Error(data?.error || `Error ${res.status}`);
        }

        showMsg('ok', `Order received! ID: ${data.order.id}`);
        btn.textContent = 'Order Submitted';
      } catch (err) {
        showMsg('err', String(err.message || err));
        btn.disabled = false; btn.textContent = 'Submit Order';
      }
    });
  </script>
</body>
</html>
