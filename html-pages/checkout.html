<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Checkout — Peptide Hub</title>
  <style>
    :root{
      --green:#1CB346;
      --green-d:#0f6b2b;
      --ink:#0f172a;
      --muted:#5b6472;
      --card:#ffffff;
      --radius:22px;
      --shadow:0 10px 30px rgba(0,0,0,.08);
      --border:#eef2f0;
      --bg:#ffffff;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,Inter,Roboto,Arial;-webkit-font-smoothing:antialiased;overflow-x:hidden;max-width:100%}
    a{text-decoration:none;color:inherit}
    img{max-width:100%;display:block}
    .container{max-width:1000px;margin:0 auto;padding:0 16px}
    /* Compact header like index */
    .header{
      position: sticky;
      top: 0;
      z-index: 40;
      background: linear-gradient(90deg, var(--green), var(--green-d));
      color: #fff;
      border-bottom: 1px solid rgba(0,0,0,.04);
    }
    .header a{ color:#fff; }
    .nav-compact{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px 0;
      padding-top:calc(12px + env(safe-area-inset-top));
    }
    .nav-compact .brand{ display:flex; align-items:center; }
    .nav-compact .brand img.logo{ height:44px; width:auto; display:block; }
    .nav-compact .actions{ display:flex; gap:10px; align-items:center; }
    .nav-btn{
      font-weight:800;color:#fff;padding:10px 14px;border-radius:12px;
      border:1px solid rgba(255,255,255,.22);background:rgba(255,255,255,.10);
      backdrop-filter:saturate(1.1);white-space:nowrap;
    }
    .nav-btn:hover{ background:rgba(255,255,255,.18); }
    @media (max-width:420px){ .nav-btn{ padding:8px 12px; font-size:.95rem } }
    /* Panels / layout */
    .panel{background:#fff;border:1px solid var(--border);border-radius:22px;box-shadow:var(--shadow);padding:16px}
    main{margin:20px 0 28px}
    .grid{
      display:grid;gap:16px;grid-template-columns:1fr;grid-template-areas:
      "order"
      "details"
      "actions";
    }
    /* Desktop: details left, order right; actions full width */
    @media (min-width:900px){
      .grid{grid-template-columns:1.1fr .9fr;grid-template-areas:
        "details order"
        "actions actions";
      }
    }
    /* Desktop: details left, order right */
    @media (min-width:900px){
      .grid{grid-template-columns:1.1fr .9fr;grid-template-areas:"details order"}
    }
    @media (min-width:900px){ .grid{ grid-template-columns:1.1fr .9fr } }
    h2,h3{margin:6px 0 12px}
    label{font-weight:700;font-size:.95rem}
    .same-row{margin-top:14px;display:flex;align-items:center;gap:8px}
    .same-row input{flex:0 0 auto}
    .same-row label{flex:0 1 auto;white-space:nowrap;margin:0}
    input,select{
      width:100%;padding:10px 12px;border:1px solid #e6e9ee;border-radius:12px;
      font-size:1rem;outline:none;transition:border-color .15s ease;
    }
    input:focus,select:focus{ border-color:#b7e6c7; box-shadow:0 0 0 3px rgba(28,179,70,.12) }
    .row{display:grid;gap:10px;grid-template-columns:1fr}
    @media (min-width:600px){ .row{ grid-template-columns:1fr 1fr } }
    .hint{color:#64748b;font-size:.85rem;margin-top:4px}
    /* Buttons */
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;background:var(--green);color:#fff;padding:12px 18px;border-radius:16px;font-weight:900;box-shadow:0 8px 20px rgba(28,179,70,.20);transition:.15s ease;border:0;cursor:pointer}
    .btn:hover{background:#17a03f;transform:translateY(-1px)}
    .btn[disabled]{opacity:.6;cursor:not-allowed;transform:none}
    /* Order list */
    .line{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px dashed #e6e9ee}
    .qtybtn{margin-left:10px;border:1px solid #e6e9ee;border-radius:8px;padding:2px 8px;background:#fff;cursor:pointer}
    .qtybtn:active{transform:translateY(1px)}
    /* Payment cards */
    .paygrid{display:grid;gap:12px;grid-template-columns:1fr}
    @media (min-width:600px){ .paygrid{grid-template-columns:1fr 1fr} }
    .pay{cursor:pointer;display:flex;gap:12px;align-items:flex-start;padding:14px;border:2px solid #eef2f0;border-radius:18px;background:#fff;position:relative}
    .pay.selected{ box-shadow:0 0 0 4px rgba(28,179,70,.12); border-color:#cdeed7 }
    .pay img{width:42px;height:42px;object-fit:contain;border-radius:12px}
    .pay .title{margin:0 0 2px;font-weight:900}
    .pay .eta{font-size:.9rem;color:#256746;margin-bottom:6px}
    .steps{display:none;color:#5b6472;font-size:.93rem;line-height:1.6;margin-top:4px}
    .pay.selected .steps{display:block}
    /* Trust */
    .trust{display:flex;gap:12px;flex-wrap:wrap;color:#64748b;font-size:.93rem}
    .pill{background:#f1f5f9;border:1px solid #e6e9ee;border-radius:999px;padding:6px 10px}
    footer{max-width:1000px;margin:28px auto 64px;padding:0 16px;color:#334155}
    footer .legal{background:#f8faf9;padding:16px;border:1px solid #e6e9ee;border-radius:16px}
  </style>
</head>
<body>
<header class="header">
  <div class="container nav-compact">
    <a aria-label="Peptide Hub — Home" class="brand" href="/">
      <img class="logo" src="assets/logo.png" alt="Peptide Hub logo">
    </a>
    <div class="actions">
      <a class="nav-btn" href="/admin">Track Your Package</a>
      <a class="nav-btn" href="/checkout" id="mini-cart-link">Cart (<span id="mini-cart-count">0</span>)</a>
    </div>
  </div>
</header>
<main class="container">
  <h2 style="margin:14px 0">Secure Checkout</h2>
  <div class="trust" aria-hidden="true">
    <span class="pill">TLS encryption</span>
    <span class="pill">Discreet packaging</span>
    <span class="pill">COA on request</span>
    <span class="pill">US-based support</span>
  </div>
  <div class="grid" style="margin-top:12px">
    <!-- Left: Customer details -->
    <section class="panel details" id="details" style="grid-area:details">
      <h3>Contact</h3>
      <div class="row">
        <div>
          <label for="email">Email</label>
          <input id="email" type="email" placeholder="you@lab.edu" required="">
          <div class="hint">We’ll email your order confirmation and tracking link.</div>
        </div>
        <div>
          <label for="phone">Phone (optional)</label>
          <input id="phone" type="tel" placeholder="(555) 555‑1234">
        </div>
      </div>
      <h3 style="margin-top:16px">Shipping address</h3>
      <div>
        <label for="ship_name">Full name</label>
        <input id="ship_name" placeholder="Full name" required="">
      </div>
      <div class="row">
        <div>
          <label for="ship_address1">Address line 1</label>
          <input id="ship_address1" placeholder="Address line 1" required="">
        </div>
        <div>
          <label for="ship_address2">Address line 2 (optional)</label>
          <input id="ship_address2" placeholder="Apt, suite, etc.">
        </div>
      </div>
      <div class="row">
        <div>
          <label for="ship_city">City</label>
          <input id="ship_city" required="">
        </div>
        <div>
          <label for="ship_state">State/Province</label>
          <input id="ship_state" required="">
        </div>
      </div>
      <div class="row">
        <div>
          <label for="ship_postal">Postal code</label>
          <input id="ship_postal" required="">
        </div>
        <div>
          <label for="ship_country">Country</label>
          <input id="ship_country" value="US" required="">
        </div>
      </div>
      <div class="same-row"><input id="same_billing" type="checkbox" checked=""><label for="same_billing">Billing same as shipping</label></div>
      <div id="billing_block" style="display:none;margin-top:10px">
        <h3>Billing address</h3>
        <div>
          <label for="bill_name">Full name</label>
          <input id="bill_name" placeholder="Full name">
        </div>
        <div class="row">
          <div>
            <label for="bill_address1">Address line 1</label>
            <input id="bill_address1" placeholder="Address line 1">
          </div>
          <div>
            <label for="bill_address2">Address line 2 (optional)</label>
            <input id="bill_address2" placeholder="Apt, suite, etc.">
          </div>
        </div>
        <div class="row">
          <div>
            <label for="bill_city">City</label>
            <input id="bill_city">
          </div>
          <div>
            <label for="bill_state">State/Province</label>
            <input id="bill_state">
          </div>
        </div>
        <div class="row">
          <div>
            <label for="bill_postal">Postal code</label>
            <input id="bill_postal">
          </div>
          <div>
            <label for="bill_country">Country</label>
            <input id="bill_country" value="US">
          </div>
        </div>
      </div>
    </section>
    <!-- Right: Order & Payment -->
    <aside class="panel order" style="grid-area:order">
      <h3>Your Order</h3>
      <div id="cart-box">
        <div id="cart-list"><div style="color:#5b6472;padding:8px">Your cart is empty. <a href="index.html#products" style="color:#1CB346;font-weight:800">Add products</a>.</div></div>
        <div style="display:flex;justify-content:space-between;font-weight:900;padding-top:8px">
          <span>Total</span><span id="total-val">$0.00</span>
        </div>
      </div>
      <h3 style="margin-top:16px">Choose a Payment Method</h3>
      <div class="paygrid" id="paygrid">
        <div class="pay" data-method="cashapp">
          <img src="assets/pay-cashapp.png" alt="Cash App">
          <div>
            <div class="title">Cash App</div>
            <div class="eta">Estimated confirmation: <strong>0–6 hours</strong></div>
            <div class="steps">
              <ol>
                <li>Open Cash App and send the <b>order total</b> to <b>$PeptideCo</b>.</li>
                <li>In the note, include: <b>Order # (shown after submit)</b>.</li>
                <li>We’ll email confirmation once received.</li>
              </ol>
            </div>
          </div>
        </div>
        <div class="pay" data-method="venmo">
          <img src="assets/pay-venmo.png" alt="Venmo">
          <div>
            <div class="title">Venmo</div>
            <div class="eta">Estimated confirmation: <strong>0–6 hours</strong></div>
            <div class="steps">
              <ol>
                <li>Open Venmo and pay the <b>order total</b> to <b>@PeptideCo</b>.</li>
                <li>Add a memo: <b>Order # (shown after submit)</b>.</li>
                <li>We’ll email confirmation once received.</li>
              </ol>
            </div>
          </div>
        </div>
        <div class="pay" data-method="zelle">
          <img src="assets/pay-zelle.png" alt="Zelle">
          <div>
            <div class="title">Zelle</div>
            <div class="eta">Estimated confirmation: <strong>0–24 hours</strong></div>
            <div class="steps">
              <ol>
                <li>Send the <b>order total</b> via Zelle to <b>support@peptideco.com</b>.</li>
                <li>Memo: <b>Order # (shown after submit)</b>.</li>
                <li>We’ll email confirmation once received.</li>
              </ol>
            </div>
          </div>
        </div>
        <div class="pay" data-method="bitcoin">
          <img src="assets/pay-bitcoin.png" alt="Bitcoin">
          <div>
            <div class="title">Bitcoin</div>
            <div class="eta">Estimated confirmation: <strong>~10–60 min</strong> (1–2 confirmations)</div>
            <div class="steps">
              <ol>
                <li>After submitting, you’ll see a <b>unique BTC address</b>.</li>
                <li>Send the <b>order total</b> to that address.</li>
                <li>We’ll confirm after 1–2 network confirmations.</li>
              </ol>
            </div>
          </div>
        </div>
      </div>
    </aside>
    <!-- Actions footer -->
    <section class="panel actions" id="actions" style="grid-area:actions">
      <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
        <a class="btn" href="/" style="background:#0f172a">Continue Shopping</a>
        <button class="btn" id="submit-order" disabled="">Submit Order</button>
      </div>
      <div class="hint" style="margin-top:8px;text-align:right">By submitting, you agree to our research‑use‑only policy.</div>
    </section>
  </div>
</main>
<footer>
  <div class="legal"><strong>Legal:</strong> For research purposes only. Not for human consumption. Must be 21+ to purchase.</div>
</footer>
<script>
// Modified checkout script with email integration
(function(){
  // Cart helpers
  function getCart(){ try{ return JSON.parse(localStorage.getItem('ph_cart')||'[]'); }catch(e){ return []; } }
  function saveCart(c){ localStorage.setItem('ph_cart', JSON.stringify(c)); document.dispatchEvent(new Event('ph_cart_updated')); }
  // Prefill from localStorage (basic)
  function getCheckout(){ try{ return JSON.parse(localStorage.getItem('ph_checkout')||'{}'); }catch(e){ return {}; } }
  function saveCheckout(data){ localStorage.setItem('ph_checkout', JSON.stringify(data)); }
  // Render mini cart count
  function renderMini(){ var span = document.getElementById('mini-cart-count'); if(!span) return;
    span.textContent = getCart().reduce((n,i)=>n+(i.qty||0),0);
  }
  document.addEventListener('ph_cart_updated', renderMini);
  window.addEventListener('storage', function(e){ if(e.key==='ph_cart') renderMini(); });
  document.addEventListener('DOMContentLoaded', renderMini);
  // Populate form from saved data
  document.addEventListener('DOMContentLoaded', function(){
    var data = getCheckout();
    ['email','phone',
     'ship_name','ship_address1','ship_address2','ship_city','ship_state','ship_postal','ship_country',
     'bill_name','bill_address1','bill_address2','bill_city','bill_state','bill_postal','bill_country'
    ].forEach(function(id){ if(data[id]){ var el=document.getElementById(id); if(el) el.value=data[id]; }});
  });
  // Toggle billing block
  var chk = document.getElementById('same_billing');
  var billing = document.getElementById('billing_block');
  function updateBillingToggle(){
    var same = chk.checked;
    billing.style.display = same ? 'none' : 'block';
    // Toggle required fields
    ['bill_name','bill_address1','bill_city','bill_state','bill_postal','bill_country'].forEach(function(id){
      var el=document.getElementById(id); if(!el) return;
      el.required = !same;
    });
  }
  chk.addEventListener('change', updateBillingToggle);
  updateBillingToggle();
  // Render cart
  var list = document.getElementById('cart-list');
  var totalEl = document.getElementById('total-val');
  function renderCart(){
    var cart = getCart();
    list.innerHTML='';
    var total=0;
    if(cart.length===0){
      list.innerHTML='<div style="color:#5b6472;padding:8px">Your cart is empty. <a href="index.html#products" style="color:#1CB346;font-weight:800">Add products</a>.</div>';
      totalEl.textContent = '$0.00';
      updateSubmitDisabled();
      return;
    }
    cart.forEach(function(item, idx){
      var line = document.createElement('div');
      line.className='line';
      var left = document.createElement('div'); left.textContent = item.name + ' — ' + item.size + ' × ' + item.qty;
      var rightWrap = document.createElement('div'); rightWrap.style.display='flex'; rightWrap.style.alignItems='center'; rightWrap.style.flexWrap='wrap'; rightWrap.style.gap='8px'; rightWrap.style.justifyContent='flex-end';
      var price = document.createElement('div'); var lineTotal = item.price * item.qty; price.textContent = '$' + lineTotal.toFixed(2); total += lineTotal;
      var minus = document.createElement('button'); minus.className='qtybtn'; minus.textContent='–'; minus.onclick=function(){ var c=getCart(); if(c[idx].qty>1){c[idx].qty-=1}else{c.splice(idx,1)}; saveCart(c); renderCart();};
      var plus = document.createElement('button'); plus.className='qtybtn'; plus.textContent='+'; plus.onclick=function(){ var c=getCart(); c[idx].qty+=1; saveCart(c); renderCart();};
      var rm = document.createElement('a'); rm.href='#'; rm.textContent='Remove'; rm.style.marginLeft='10px'; rm.style.color='#b91c1c'; rm.style.fontWeight='800'; rm.onclick=function(e){e.preventDefault(); var c=getCart(); c.splice(idx,1); saveCart(c); renderCart();};
      rightWrap.appendChild(price); rightWrap.appendChild(minus); rightWrap.appendChild(plus); rightWrap.appendChild(rm);
      line.appendChild(left); line.appendChild(rightWrap); list.appendChild(line);
    });
    totalEl.textContent = '$' + total.toFixed(2);
    updateSubmitDisabled();
  }
  document.addEventListener('DOMContentLoaded', renderCart);
  document.addEventListener('ph_cart_updated', renderCart);
  // Payment selection
  var selected = null;
  document.querySelectorAll('.pay').forEach(function(card){
    card.addEventListener('click', function(){
      document.querySelectorAll('.pay').forEach(function(x){ x.classList.remove('selected'); });
      card.classList.add('selected');
      selected = card.getAttribute('data-method');
      updateSubmitDisabled();
    });
  });
  // Enable/disable submit
  var submitBtn = document.getElementById('submit-order');
  function requiredFilled(){
    var ids = ['email','ship_name','ship_address1','ship_city','ship_state','ship_postal','ship_country'];
    if(!chk.checked){ ids = ids.concat(['bill_name','bill_address1','bill_city','bill_state','bill_postal','bill_country']); }
    for(var i=0;i<ids.length;i++){
      var el=document.getElementById(ids[i]);
      if(!el || !el.value.trim()){ return false; }
      if(el.id==='email' && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(el.value)) return false;
    }
    return true;
  }
  function updateSubmitDisabled(){
    var cartOk = getCart().length>0;
    submitBtn.disabled = !(cartOk && selected && requiredFilled());
  }
  document.addEventListener('input', updateSubmitDisabled);
    // Submit handler using order-create function
    submitBtn.addEventListener('click', async function() {
      if (submitBtn.disabled) return;
      // Collect and save checkout info locally
      var data = {};
      [
        'email','phone',
        'ship_name','ship_address1','ship_address2','ship_city','ship_state','ship_postal','ship_country',
        'bill_name','bill_address1','bill_address2','bill_city','bill_state','bill_postal','bill_country'
      ].forEach(function(id) {
        var el = document.getElementById(id);
        if (el) data[id] = el.value;
      });
      data['same_billing'] = chk.checked;
      saveCheckout(data);
      // Prepare payload for order-create function
      var cart = getCart();
      var customer = {
        email: data.email,
        phone: data.phone,
        ship_name: data.ship_name,
        ship_address1: data.ship_address1,
        ship_address2: data.ship_address2,
        ship_city: data.ship_city,
        ship_state: data.ship_state,
        ship_postal: data.ship_postal,
        ship_country: data.ship_country,
        same_billing: data.same_billing,
        bill_name: data.bill_name,
        bill_address1: data.bill_address1,
        bill_address2: data.bill_address2,
        bill_city: data.bill_city,
        bill_state: data.bill_state,
        bill_postal: data.bill_postal,
        bill_country: data.bill_country
      };
      var payload = {
        customer: customer,
        cart: cart,
        payment_method: selected
      };
      try {
        var resp = await fetch('/.netlify/functions/order-create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        var resData = await resp.json();
        if (!resp.ok || !resData || !resData.ok) {
          console.error('Order creation failed', resData);
          alert('There was a problem submitting your order. Please try again.');
          return;
        }
        // Persist order info for payment instructions page
        localStorage.setItem('orderId', resData.orderId);
        localStorage.setItem('orderTotal', Number(resData.total).toFixed(2));
        localStorage.setItem('method', selected);
        // Redirect to payment instructions page
        var url = new URL('payment-instructions.html', window.location.href);
        url.searchParams.set('method', selected);
        url.searchParams.set('order', resData.orderId);
        url.searchParams.set('total', Number(resData.total).toFixed(2));
        window.location.href = url.toString();
      } catch (err) {
        console.error('Failed to create order', err);
        alert('There was a problem submitting your order. Please try again later.');
      }
    });
})();
</script>
</body>
</html>
